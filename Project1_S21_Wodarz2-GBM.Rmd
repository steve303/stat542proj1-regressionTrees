---
title: "Project 1: Predict the Housing Prices in Ames"
date: "Spring 2021"
output:
  html_notebook:
    theme: readable
    toc: TRUE
    toc_float: TRUE
---

## Ames Housing Data

### Data set

Download the dataset, `Ames_data.csv`, from the Resouces page on Piazza. The dataset has 2930 rows (i.e., houses) and 83 columns. 

* The first column is "PID", the Parcel identification number; 
* The last column is the response variable, `Sale_Price`;
* The remaining 81 columns are explanatory variables describing (almost) every aspect of residential homes.

### Test IDs
  
Download `project1_testIDs.dat` from the Resouces page on Piazza. This file contains 879 rows and 10 columns, which will be used to generate **10 sets** of training/test splits from `Ames_data.csv`. Each column contains the 879 row-numbers of a test data.  

Here is how you generate a split of training and test using the j-th column of `project1_testIDs.dat` in R. 

```{r eval = FALSE}
data <- read.csv("Ames_data.csv")
testIDs <- read.table("project1_testIDs.dat")
j <- 2
train <- data[-testIDs[,j], ]
test <- data[testIDs[,j], ]
test.y <- test[, c(1, 83)]
test <- test[, -83]
write.csv(train,"train.csv",row.names=FALSE)
write.csv(test, "test.csv",row.names=FALSE)
write.csv(test.y,"test_y.csv",row.names=FALSE)
```
Save the training and test as csv files. In particular, the test data are saved as two seperate two files: one containing just the feature vectors and the other one containing the response column. 

For your remaining analysis, you need to read the training and test data from the csv files.

```{r eval = FALSE}
train <- read.csv("train.csv")
test <- read.csv("test.csv")
```
  


```{r}
# Step 0: Load necessary libraries
###########################################
# Step 0: Load necessary libraries
#
# YOUR CODE
# 
library(gbm)


###########################################
# Step 1: Preprocess training data
#         and fit two models
#
train <- read.csv("train.csv")
#
# YOUR CODE
# 


# Character column to factor
train[sapply(train, is.character)] = lapply(train[sapply(train, is.character)], as.factor)

n = nrow(train)
myfit1 = gbm(log(Sale_Price) ~ ., data = train[,-which(names(train) == "PID" )],
             distribution =  "gaussian",
             n.trees = 500,
             shrinkage = 0.1,
             interaction.depth = 5,
             bag.fraction = 1,
             cv.folds = 5)


###########################################
# Step 2: Preprocess test data
#         and output predictions into two files
#
test <- read.csv("test.csv")
#
# YOUR CODE
# 


# Character column to factor
for(i in 1:ncol(test)){
  if(is.character(test[,i])){
    test[,i] = factor(test[,i], levels = levels(train[,i]))
  }
}

test.y.pred = exp(predict(myfit1, newdata=test))
test.y.pred = data.frame(PID = test[,1], Sale_Price = test.y.pred)
write.csv(test.y.pred, file = "mysubmission1.txt",  quote= FALSE, row.names = FALSE)

```


Performance
```{r}
pred <- read.csv("mysubmission1.txt")
names(test.y)[2] <- "True_Sale_Price"
pred <- merge(pred, test.y, by="PID")
sqrt(mean((log(pred$Sale_Price) - log(pred$True_Sale_Price))^2))
```


```{r}
for(j in 1:10){
train <- data[-testIDs[,j], ]
test <- data[testIDs[,j], ]
test.y <- test[, c(1, 83)]
test <- test[, -83]
write.csv(train,"train.csv",row.names=FALSE)
write.csv(test, "test.csv",row.names=FALSE)
write.csv(test.y,"test_y.csv",row.names=FALSE)
train <- read.csv("train.csv")
test <- read.csv("test.csv")
train[sapply(train, is.character)] = lapply(train[sapply(train, is.character)], as.factor)

n = nrow(train)
myfit1 = gbm(log(Sale_Price) ~ ., data = train[,-which(names(train) == "PID" )],
             distribution =  "gaussian",
             n.trees = 500,
             shrinkage = 0.1,
             interaction.depth = 5,
             bag.fraction = 1,
             cv.folds = 5)
for(i in 1:ncol(test)){
  if(is.character(test[,i])){
    test[,i] = factor(test[,i], levels = levels(train[,i]))
  }
}

test.y.pred = exp(predict(myfit1, newdata=test))
test.y.pred = data.frame(PID = test[,1], Sale_Price = test.y.pred)
write.csv(test.y.pred, file = paste("mysubmission",j,".txt", sep=""),  quote= FALSE, row.names = FALSE)
}
```

```{r}
for(j in 1:10){
pred <- read.csv(paste("mysubmission",j,".txt", sep=""))
test <- data[testIDs[,j], ]
test.y <- test[, c(1, 83)]
names(test.y)[2] <- "True_Sale_Price"
pred <- merge(pred, test.y, by="PID")
print(sqrt(mean((log(pred$Sale_Price) - log(pred$True_Sale_Price))^2)))
}
```

